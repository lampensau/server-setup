# nginx Service Security Hardening - Systemd Sandboxing
# CIS NGINX Benchmark v2.1.0 compliant systemd configuration

[Service]
# Security and sandboxing
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/log/nginx /var/lib/nginx /run /var/cache/nginx
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes
ProtectControlGroups=yes
ProtectProc=invisible
ProcSubset=pid
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6 AF_NETLINK
RestrictNamespaces=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
RemoveIPC=yes
PrivateTmp=yes
PrivateDevices=yes
ProtectClock=yes
ProtectHostname=yes

# Capabilities
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETGID CAP_SETUID
AmbientCapabilities=CAP_NET_BIND_SERVICE CAP_SETGID CAP_SETUID

# System calls
SystemCallFilter=@system-service
SystemCallFilter=~@debug @mount @cpu-emulation @obsolete @privileged @reboot @swap @resources

# File system
TemporaryFileSystem=/tmp
BindReadOnlyPaths=/etc/nginx
BindReadOnlyPaths=/etc/ssl
BindReadOnlyPaths=/usr/share/nginx

# Resource limits
LimitNOFILE=65536
LimitNPROC=32768
LimitCORE=0

# User and group (ensure nginx runs as www-data)
User=www-data
Group=www-data

# Additional security
UMask=0022
SecureBits=keep-caps-locked noroot-locked no-setuid-fixup-locked

# Process monitoring
Restart=always
RestartSec=10
KillMode=mixed
KillSignal=SIGQUIT
TimeoutStopSec=5