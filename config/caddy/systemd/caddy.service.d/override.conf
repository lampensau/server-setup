# Caddy Service Security Hardening - Systemd Sandboxing
# Modern security configuration for Caddy

[Service]
# Security and sandboxing
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/log/caddy /var/lib/caddy /etc/caddy /var/www
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes
ProtectControlGroups=yes
ProtectProc=invisible
ProcSubset=pid
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6 AF_NETLINK
RestrictNamespaces=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
RemoveIPC=yes
PrivateTmp=yes
PrivateDevices=yes
ProtectClock=yes
ProtectHostname=yes

# Capabilities (Caddy needs these for automatic HTTPS)
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETGID CAP_SETUID
AmbientCapabilities=CAP_NET_BIND_SERVICE

# System calls
SystemCallFilter=@system-service
SystemCallFilter=~@debug @mount @cpu-emulation @obsolete @privileged @reboot @swap @clock

# File system
TemporaryFileSystem=/tmp
BindReadOnlyPaths=/etc/ssl/certs

# Resource limits
LimitNOFILE=1048576
LimitNPROC=32768
LimitCORE=0

# User and group
User=caddy
Group=caddy

# Additional security
UMask=0022
SecureBits=keep-caps-locked noroot-locked no-setuid-fixup-locked

# Process monitoring
Restart=on-abnormal
RestartSec=5
KillMode=mixed
KillSignal=SIGTERM
TimeoutStopSec=5

# Environment
Environment=XDG_CONFIG_HOME=/var/lib/caddy/.config
Environment=XDG_DATA_HOME=/var/lib/caddy/.local/share