# Caddy Main Configuration - Secure by Default
# Automatic HTTPS with modern security practices

{
    # Global options
    admin off
    
    # Security settings
    servers {
        timeouts {
            read_body   10s
            read_header 10s
            write       10s
            idle        2m
        }
        
        max_header_size 16KB
        
        # Security headers (global)
        header {
            # Remove sensitive server information
            -Server
            -X-Powered-By
            
            # Security headers
            X-Content-Type-Options nosniff
            X-Frame-Options SAMEORIGIN
            X-XSS-Protection "1; mode=block"
            Referrer-Policy "strict-origin-when-cross-origin"
            Permissions-Policy "geolocation=(), microphone=(), camera=()"
        }
    }
    
    # Email for Let's Encrypt ACME
    email admin@localhost
    
    # ACME CA for Let's Encrypt
    acme_ca https://acme-v02.api.letsencrypt.org/directory
    
    # Local CA for development (uncomment for local development)
    # local_certs
    
    # Storage location for certificates
    storage file_system {
        root /var/lib/caddy/.local/share/caddy
    }
    
    # TLS configuration
    default_bind 0.0.0.0
    
    # Rate limiting (global)
    rate_limit {
        zone static {
            key {remote_host}
            events 100
            window 1m
        }
        zone api {
            key {remote_host}
            events 20
            window 1m
        }
        zone login {
            key {remote_host}
            events 5
            window 1m
        }
    }
}

# Default site configuration
:80, :443 {
    # Document root
    root * /var/www/html
    
    # Default file serving
    file_server
    
    # Security headers (site-specific)
    header {
        # HSTS (only for HTTPS)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Content Security Policy (adjust per application)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; frame-ancestors 'self';"
        
        # Additional security headers
        X-Frame-Options SAMEORIGIN
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Health check endpoint
    respond /health "healthy" 200
    
    # Security.txt (RFC 9116)
    handle /.well-known/security.txt {
        file_server
    }
    
    # Hide sensitive files and directories
    @hidden {
        path */.*
        path */.git/*
        path */.svn/*
        path */.hg/*
        path */.bzr/*
        path *.bak
        path *.backup
        path *.old
        path *.orig
        path *.tmp
        path *.temp
        path *.log
        path *.logs
        path *.conf
        path *.config
        path *.cfg
        path *.ini
    }
    respond @hidden 404
    
    # Static asset optimization
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
    }
    
    # Rate limiting
    rate_limit {
        zone static
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100MB
            roll_keep 10
            roll_keep_for 720h
        }
        format json
        level INFO
    }
    
    # Error handling
    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        @5xx {
            expression {http.error.status_code} >= 500
        }
        
        handle @404 {
            respond "Page not found" 404
        }
        
        handle @5xx {
            respond "Server error" 500
        }
    }
}

# Include additional site configurations
import /etc/caddy/conf.d/*.caddy