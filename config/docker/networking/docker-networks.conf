#!/bin/bash
# Docker Network Security Configuration
# Creates secure network isolation for Docker containers

# Remove default bridge network isolation (handled by daemon config)
# Create custom networks with proper isolation

# DMZ Network - Internet-facing services (reverse proxy, etc.)
docker network create \
  --driver bridge \
  --subnet=172.20.0.0/16 \
  --ip-range=172.20.240.0/20 \
  --gateway=172.20.0.1 \
  --opt com.docker.network.bridge.name=docker-dmz \
  --opt com.docker.network.bridge.enable_icc=false \
  --opt com.docker.network.bridge.enable_ip_masquerade=true \
  --opt com.docker.network.bridge.host_binding_ipv4=0.0.0.0 \
  dmz-network 2>/dev/null || true

# Application Network - Application containers
docker network create \
  --driver bridge \
  --subnet=172.21.0.0/16 \
  --ip-range=172.21.240.0/20 \
  --gateway=172.21.0.1 \
  --opt com.docker.network.bridge.name=docker-app \
  --opt com.docker.network.bridge.enable_icc=false \
  --opt com.docker.network.bridge.enable_ip_masquerade=true \
  --internal \
  app-network 2>/dev/null || true

# Data Network - Database and storage containers
docker network create \
  --driver bridge \
  --subnet=172.22.0.0/16 \
  --ip-range=172.22.240.0/20 \
  --gateway=172.22.0.1 \
  --opt com.docker.network.bridge.name=docker-data \
  --opt com.docker.network.bridge.enable_icc=false \
  --opt com.docker.network.bridge.enable_ip_masquerade=false \
  --internal \
  data-network 2>/dev/null || true

# Coolify Management Network - Coolify internal communications
docker network create \
  --driver bridge \
  --subnet=172.23.0.0/16 \
  --ip-range=172.23.240.0/20 \
  --gateway=172.23.0.1 \
  --opt com.docker.network.bridge.name=coolify-mgmt \
  --opt com.docker.network.bridge.enable_icc=true \
  --opt com.docker.network.bridge.enable_ip_masquerade=true \
  coolify-network 2>/dev/null || true

echo "Docker networks configured with security isolation"